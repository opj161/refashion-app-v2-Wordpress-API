# Integrating Visionatrix: Getting Started

This guide will help you get started with programmatically interacting with Visionatrix.

!!! note

    **SDXL Lighting** and **Remove Background (Birefnet)** flows should be installed on the Visionatrix instance.

    This guide only covers how to create tasks from a flow, fetch their progress, and receive the results.

!!! info

    We constantly strive to make our API more comfortable to use with code generated by Claude, Qwen, or ChatGPT.

    However, this guide is primarily focused on understanding the lifespan of a task. It does not describe how to automatically create a Gradio application for the specified flow or any other such topics.

---

## Table of Contents

1. [Authentication](#authentication)
2. [Task Lifecycle](#task-lifecycle)
3. [Full Working Examples in Python](#full-working-examples-in-python)
    - [Example 1: Using the "SDXL Lighting" Flow](#example-1-using-the-sdxl-lighting-flow)
    - [Example 2: Using the "Remove Background (Birefnet)" Flow](#example-2-using-the-remove-background-birefnet-flow)

## Authentication

Visionatrix *currently* supports **Basic Authentication** only. Depending on the mode in which Visionatrix is running, you may or may not need to provide authentication credentials:

- **SERVER Mode**: If Visionatrix is running in SERVER mode, you **must** specify your username and password in your API requests.
- **DEFAULT Mode**: If Visionatrix is running in DEFAULT mode, **no authentication** is required.

For the purposes of this guide, we will assume that authentication is required.

By default, we use `admin` as both the username and password in our development setups for **SERVER mode** when testing Visionatrix. Replace these with your actual credentials if they are different.

## Task Lifecycle

The typical lifecycle of a task in Visionatrix involves the following steps:

1. **Creating a Task**: You send a `PUT` request to the `/vapi/tasks/create/{name}` endpoint, where `{name}` is the ID of the flow you want to use. The request must use `multipart/form-data` and include the necessary parameters for the flow.

   - For the **SDXL Lighting** (`sdxl_lighting`) flow, required parameters are:
     - `prompt` (string): The text prompt for image generation.
     - `steps_number` (string): The number of steps to use.
   - **Optional Parameters**:
     - `negative_prompt` (string): The "negative" text prompt for image generation.
     - `seed` (integer): The seed for random number generation. If not specified, a random seed will be used.

   - For the **Remove Background (Birefnet)** (`remove_background_birefnet`) flow, required parameters are:
     - `input_image` (file): The image file from which to remove the background.

   - **Other Parameters**:
     - There are additional optional parameters such as `webhook_url`, `webhook_headers`, `translate`, `group_scope`, etc. These parameters are not covered in this beginner guide.

2. **Checking Task Progress**: After creating a task, you can check its progress using the `/vapi/tasks/progress/{task_id}` endpoint. The response includes details such as the task's `progress`, `error` (if any), and a list of `outputs`.

   - **Progress Values**:
     - `0.0`: Task is queued and has not started yet.
     - Between `0.1` and `99.9`: Task is in progress.
     - `100.0`: Task is completed.

   - **Error Handling**:
     - If the `error` field is not empty, the task has encountered an error.
     - You can retry the task or investigate the issue based on the error message.

3. **Retrieving Task Results**: Once a task is completed (`progress` reaches `100.0`), you can retrieve the results using the `/vapi/tasks/results` endpoint. The `outputs` from the task details contain a list of output nodes, each with a `comfy_node_id`. You should iterate over all the outputs to retrieve all results.

   - To retrieve each result, you send a `GET` request to `/vapi/tasks/results` with the `task_id` and `node_id` (which is the `comfy_node_id` from the outputs).
   - The result files can then be saved locally. The format of the result file depends on the flow and the output node's type.

!!! note

    We are currently in the process of automatically creating OpenAPI specifications for the flows: [Flows API](https://visionatrix.github.io/VixFlowsDocs/swagger.html?urls.primaryName=Visionatrix+Flows+API).

    You can easily take a look at the flow parameters there.

## Full Working Examples in Python

Below are full working examples in Python using the `httpx` library. These scripts demonstrate how to create a task, check its progress, and retrieve all the results for both the `sdxl_lighting` and `remove_background_birefnet` flows.

Before running the scripts, make sure you have the `httpx` library installed:

```bash
pip install httpx
```

### Example 1: Using the "SDXL Lighting" Flow

```python
import httpx
import time

# Replace with your Visionatrix server URL
base_url = "http://localhost:8288"
username = "admin"
password = "admin"


def create_sdxl_lighting_task():
    # Task parameters
    params = {
        'prompt': 'A beautiful sunset over the mountains',
        'steps_number': '8 steps',
        # 'negative_prompt' is optional
        # 'negative_prompt': 'blurry, low resolution',
        # 'seed' is optional; if not specified, a random seed will be used
        # 'seed': '12345',
    }

    # Convert parameters to the format expected by the 'files' parameter
    files = {key: (None, value) for key, value in params.items()}

    # Create the task
    response = httpx.put(
        f"{base_url}/vapi/tasks/create/sdxl_lighting",
        auth=(username, password),
        files=files
    )

    # Check if the request was successful
    if response.status_code == 200:
        data = response.json()
        task_ids = data.get('tasks_ids', [])
        if task_ids:
            task_id = task_ids[0]
            print("Task created successfully. Task ID:", task_id)
            return task_id
        else:
            print("No task ID returned.")
    else:
        print("Failed to create task:", response.text)
    return None


def check_task_progress(task_id):
    while True:
        response = httpx.get(
            f"{base_url}/vapi/tasks/progress/{task_id}",
            auth=(username, password)
        )

        if response.status_code == 200:
            task_details = response.json()
            progress = task_details.get('progress', 0)
            error = task_details.get('error', '')
            print(f"Task {task_id} progress: {progress}%")
            if error:
                print(f"Task {task_id} encountered an error: {error}")
                return None
            if progress >= 100:
                print("Task completed.")
                outputs = task_details.get('outputs', [])
                return outputs  # Return outputs to avoid additional server call
        else:
            print("Failed to get task progress:", response.text)
            return None

        # Wait before polling again
        time.sleep(5)


def retrieve_task_results(task_id, outputs):
    if outputs:
        for output in outputs:
            node_id = output.get('comfy_node_id')
            if node_id is not None:
                # Retrieve the result for each output node
                params = {
                    'task_id': task_id,
                    'node_id': node_id
                }
                result_response = httpx.get(
                    f"{base_url}/vapi/tasks/results",
                    auth=(username, password),
                    params=params
                )
                if result_response.status_code == 200:
                    # Save the result to a file
                    result_filename = f"result_{task_id}_{node_id}.png"
                    with open(result_filename, 'wb') as f:
                        f.write(result_response.content)
                    print(f"Result saved to {result_filename}")
                else:
                    print(f"Failed to retrieve result for node {node_id}:", result_response.text)
            else:
                print("Output node ID not found.")
    else:
        print("No outputs found in task details.")


def main():
    task_id = create_sdxl_lighting_task()
    if task_id:
        outputs = check_task_progress(task_id)
        if outputs is not None:
            retrieve_task_results(task_id, outputs)


if __name__ == "__main__":
    main()
```

### Example 2: Using the "Remove Background (Birefnet)" Flow

```python
import httpx
import time

# Replace with your Visionatrix server URL
base_url = "http://localhost:8288"
username = "admin"
password = "admin"
input_image_path = "image.jpg"


def create_remove_background_task():
    # Open the image file in binary mode
    with open(input_image_path, 'rb') as image_file:
        files = {
            'input_image': image_file
        }

        # Create the task
        response = httpx.put(
            f"{base_url}/vapi/tasks/create/remove_background_birefnet",
            auth=(username, password),
            files=files
        )

    # Check if the request was successful
    if response.status_code == 200:
        data = response.json()
        task_ids = data.get('tasks_ids', [])
        if task_ids:
            task_id = task_ids[0]
            print("Task created successfully. Task ID:", task_id)
            return task_id
        else:
            print("No task ID returned.")
    else:
        print("Failed to create task:", response.text)
    return None


def check_task_progress(task_id):
    while True:
        response = httpx.get(
            f"{base_url}/vapi/tasks/progress/{task_id}",
            auth=(username, password)
        )

        if response.status_code == 200:
            task_details = response.json()
            progress = task_details.get('progress', 0)
            error = task_details.get('error', '')
            print(f"Task {task_id} progress: {progress}%")
            if error:
                print(f"Task {task_id} encountered an error: {error}")
                return None
            if progress >= 100:
                print("Task completed.")
                outputs = task_details.get('outputs', [])
                return outputs  # Return outputs to avoid additional server call
        else:
            print("Failed to get task progress:", response.text)
            return None

        # Wait before polling again
        time.sleep(5)


def retrieve_task_results(task_id, outputs):
    if outputs:
        for output in outputs:
            node_id = output.get('comfy_node_id')
            if node_id is not None:
                # Retrieve the result for each output node
                params = {
                    'task_id': task_id,
                    'node_id': node_id
                }
                result_response = httpx.get(
                    f"{base_url}/vapi/tasks/results",
                    auth=(username, password),
                    params=params
                )
                if result_response.status_code == 200:
                    # Save the result to a file
                    result_filename = f"result_{task_id}_{node_id}.png"
                    with open(result_filename, 'wb') as f:
                        f.write(result_response.content)
                    print(f"Result saved to {result_filename}")
                else:
                    print(f"Failed to retrieve result for node {node_id}:", result_response.text)
            else:
                print("Output node ID not found.")
    else:
        print("No outputs found in task details.")


def main():
    task_id = create_remove_background_task()
    if task_id:
        outputs = check_task_progress(task_id)
        if outputs is not None:
            retrieve_task_results(task_id, outputs)


if __name__ == "__main__":
    main()
```

---

**Notes**:

- Replace `base_url` with your actual Visionatrix server URL if it's different.
- For the second example, replace `input_image_path` with the path to your input image file. Ensure that the file exists at the specified path.
- When creating a task, the API expects a `PUT` request with `multipart/form-data`. Therefore, even if you are not uploading any files (as in the `sdxl_lighting` flow), you should use `files=params` to ensure the request uses the correct content type.
- These scripts include basic error handling and polling logic.
- The `check_task_progress` function polls the task progress every 5 seconds. Adjust the sleep time as needed.
- The `retrieve_task_results` function uses the `outputs` obtained from the `check_task_progress` function, avoiding an additional call to the server.
- The result files are saved in the current working directory with filenames that include the task ID and node ID.
- Ensure that the required flows (`sdxl_lighting` and `remove_background_birefnet`) are installed on your Visionatrix instance before running these scripts.
- Additional optional parameters like `webhook_url`, `translate`, `group_scope`, `seed`, etc., are available but are not covered in this beginner guide.

---

## RefashionAI Integration

RefashionAI has implemented the Visionatrix background removal feature as an optional enhancement to the clothing image upload workflow. Here's how it works:

### Implementation Details

The background removal feature is implemented in the RefashionAI application with the following components:

#### Server-Side Services
- **`src/ai/services/visionatrix-api.ts`**: Core API service for Visionatrix integration
- **`src/ai/actions/remove-background.ts`**: Server action that handles background removal workflow

#### Client-Side Integration
- **Background Removal Toggle**: Available in the upload section when Visionatrix is accessible
- **Progress Tracking**: Real-time progress updates during background removal
- **Automatic Fallback**: Falls back to original image if background removal fails

### Configuration

Set these environment variables to enable background removal:

```env
VISIONATRIX_API_URL=http://localhost:8288  # Your Visionatrix server URL
VISIONATRIX_USERNAME=admin                 # Default: admin
VISIONATRIX_PASSWORD=admin                 # Default: admin
```

### User Experience

1. **Upload Flow**: User uploads a clothing image
2. **Option Available**: If Visionatrix is available, a "Remove Background" toggle appears
3. **Processing**: When enabled, background removal processes automatically during upload
4. **Progress**: Users see real-time progress updates
5. **Fallback**: If background removal fails, the original image is used seamlessly

### Technical Implementation

The integration uses the `remove_background_birefnet` flow with the following workflow:

1. **Availability Check**: On app startup, checks if Visionatrix is accessible
2. **Task Creation**: Creates background removal task with uploaded image
3. **Progress Polling**: Polls every 5 seconds with 5-minute timeout
4. **Result Processing**: Downloads and saves the processed image locally
5. **Integration**: Processed image is used in the AI generation workflow

### Error Handling

- **Service Unavailable**: Toggle is hidden, feature gracefully disabled
- **Processing Failure**: Falls back to original image with user notification
- **Network Issues**: Automatic retry with exponential backoff
- **Timeout**: Falls back after 5-minute timeout

This implementation ensures that background removal enhances the user experience when available, while maintaining full functionality even when the service is unavailable.
